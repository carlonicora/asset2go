# =============================================================================
# ASSETTRACK MONOREPO - DOCKER COMPOSE CONFIGURATION
# =============================================================================
# This docker-compose.yml references environment variables from the root .env file
# It can also work with Coolify where variables are injected via Coolify's UI
#
# IMPORTANT: Infrastructure services (Neo4j, Redis, MinIO) are expected to run
# externally and are configured via the .env file connection strings.
#
# Usage:
#   docker compose up                     # Start all three services (api, worker, web)
#   docker compose up api                 # Start only API service
#   docker compose up worker              # Start only Worker service
#   docker compose up web                 # Start only Web service
#   docker compose up api worker          # Start API and Worker services
# =============================================================================
x-api-worker-shared-env: &api_worker_shared_env
  NODE_ENV: ${NODE_ENV:-production}

  # Database - Use .env values (external services)
  NEO4J_URI: ${NEO4J_URI}
  NEO4J_USER: ${NEO4J_USER}
  NEO4J_PASSWORD: ${NEO4J_PASSWORD}
  NEO4J_DATABASE: ${NEO4J_DATABASE}

  # Cache & Queue - Use .env values (external services)
  REDIS_HOST: ${REDIS_HOST}
  REDIS_PORT: ${REDIS_PORT}
  REDIS_PASSWORD: ${REDIS_PASSWORD}
  REDIS_USERNAME: ${REDIS_USERNAME}
  QUEUE: ${QUEUE}

  # Authentication
  JWT_SECRET: ${JWT_SECRET}
  JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}

  # Web Push - VAPID
  VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
  VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
  VAPID_EMAIL: ${VAPID_EMAIL}

  # Email Configuration
  EMAIL_PROVIDER: ${EMAIL_PROVIDER}
  EMAIL_API_KEY: ${EMAIL_API_KEY}
  EMAIL_FROM: ${EMAIL_FROM}
  EMAIL_HOST: ${EMAIL_HOST}
  EMAIL_PORT: ${EMAIL_PORT}
  EMAIL_SECURE: ${EMAIL_SECURE}
  EMAIL_USERNAME: ${EMAIL_USERNAME}
  EMAIL_PASSWORD: ${EMAIL_PASSWORD}

  # Logging - Loki
  LOKI_ENABLED: ${LOKI_ENABLED}
  LOKI_HOST: ${LOKI_HOST}
  LOKI_USERNAME: ${LOKI_USERNAME}
  LOKI_PASSWORD: ${LOKI_PASSWORD}
  LOKI_APP_LABEL: ${LOKI_APP_LABEL}

  # Tracing - Tempo
  TEMPO_ENABLED: ${TEMPO_ENABLED}
  TEMPO_ENDPOINT: ${TEMPO_ENDPOINT}
  TEMPO_SERVICE_NAME: ${TEMPO_SERVICE_NAME}
  TEMPO_SERVICE_VERSION: ${TEMPO_SERVICE_VERSION}

  # Object Storage - S3/MinIO - Use .env values (external services)
  S3_TYPE: ${S3_TYPE}
  S3_ENDPOINT: ${S3_ENDPOINT}
  S3_BUCKET: ${S3_BUCKET}
  S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
  S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
  S3_REGION: ${S3_REGION}

  # UPC Database
  UPC_ENABLED: ${UPC_ENABLED}
  UPC_API_KEY: ${UPC_API_KEY}

# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Server (NestJS Backend)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api-production
      args:
        - API_PORT=${API_PORT:-3500}
    ports:
      - "${API_PORT:-3500}:${API_PORT:-3500}"
    environment:
      <<: *api_worker_shared_env
      # Build & Application Mode
      PORT: ${API_PORT:-3500}
      API_URL: ${API_URL}
      API_PORT: ${API_PORT:-3500}
      NODE_OPTIONS: ${API_NODE_OPTIONS:-"--max-old-space-size=6144"}

      # Cache Configuration
      CACHE_ENABLED: ${CACHE_ENABLED}
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL}
      CACHE_SKIP_PATTERNS: ${CACHE_SKIP_PATTERNS}

      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS}
      IP_RATE_LIMIT_REQUESTS: ${IP_RATE_LIMIT_REQUESTS}

      # CORS Configuration
      CORS_ORIGINS: ${CORS_ORIGINS}
      CORS_ORIGIN_PATTERNS: ${CORS_ORIGIN_PATTERNS}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS}
      CORS_METHODS: ${CORS_METHODS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS}
      CORS_MAX_AGE: ${CORS_MAX_AGE}
      CORS_PREFLIGHT_CONTINUE: ${CORS_PREFLIGHT_CONTINUE}
      CORS_OPTIONS_SUCCESS_STATUS: ${CORS_OPTIONS_SUCCESS_STATUS}
      CORS_LOG_VIOLATIONS: ${CORS_LOG_VIOLATIONS}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get({host:'localhost',port:process.env.API_PORT||3500,path:'/version'},(r)=>process.exit(r.statusCode>=200&&r.statusCode<500?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Worker (Background Job Processing)
  # ---------------------------------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: api-production
    environment:
      <<: *api_worker_shared_env
      NODE_OPTIONS: ${WORKER_NODE_OPTIONS:-"--max-old-space-size=6144"}
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*dist/main.*worker"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command:
      - node
      - dist/main
      - --mode=worker

  # ---------------------------------------------------------------------------
  # Web Application (Next.js Frontend)
  # ---------------------------------------------------------------------------
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: web-production
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_ADDRESS=${NEXT_PUBLIC_ADDRESS}
        - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}
        - NEXT_PUBLIC_FARO_URL=${NEXT_PUBLIC_FARO_URL}
        - NEXT_PUBLIC_FARO_APP_NAME=${NEXT_PUBLIC_FARO_APP_NAME:-asset2go-web}
        - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
        - NEXT_PUBLIC_ENVIRONMENT=${NEXT_PUBLIC_ENVIRONMENT:-production}
        - PORT=${PORT:-3501}
    ports:
      - "${PORT:-3501}:${PORT:-3501}"
    environment:
      # Build & Application Configuration
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3501}
      - APP_URL=${APP_URL}
      - NODE_OPTIONS=${WEB_NODE_OPTIONS:-"--max-old-space-size=4096"}

      # API Connection
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_ADDRESS=${NEXT_PUBLIC_ADDRESS}
      - API_INTERNAL_URL=${API_INTERNAL_URL:-http://api:3500/}

      # Web Push - VAPID
      - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}

      # Frontend Observability - Grafana Faro
      - NEXT_PUBLIC_FARO_URL=${NEXT_PUBLIC_FARO_URL}
      - NEXT_PUBLIC_FARO_APP_NAME=${NEXT_PUBLIC_FARO_APP_NAME:-asset2go-web}
      - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
      - NEXT_PUBLIC_ENVIRONMENT=${NEXT_PUBLIC_ENVIRONMENT:-production}

      # Image Sources
      - IMAGE_SOURCES=${IMAGE_SOURCES}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get({host:'localhost',port:process.env.PORT||3501,path:'/'},(r)=>process.exit(r.statusCode>=200&&r.statusCode<500?0:1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Grafana Faro Collector (Frontend Observability)
  # ---------------------------------------------------------------------------
  # Receives frontend telemetry (errors, performance, web vitals) and forwards
  # to Grafana Loki for logs and Grafana Tempo for traces.
  # Accessible at http://faro-collector:12345/collect
  # ---------------------------------------------------------------------------
  faro-collector:
    profiles:
      - observability
    image: grafana/faro-collector:latest
    ports:
      - "12345:12345"
    environment:
      - FARO_RECEIVER_HOST=0.0.0.0
      - FARO_RECEIVER_PORT=12345
      # Send logs to Loki (if enabled)
      - FARO_LOKI_ENABLED=${LOKI_ENABLED:-false}
      - FARO_LOKI_URL=${LOKI_HOST}
      - FARO_LOKI_USERNAME=${LOKI_USERNAME}
      - FARO_LOKI_PASSWORD=${LOKI_PASSWORD}
      # Send traces to Tempo (if enabled)
      - FARO_TEMPO_ENABLED=${TEMPO_ENABLED:-false}
      - FARO_TEMPO_URL=${TEMPO_ENDPOINT}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:12345/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

# =============================================================================
# NETWORKS
# =============================================================================
# Note: No custom networks defined. Docker Compose will create a default network
# automatically for local development. In production (Coolify), the override file
# adds services to the external 'coolify' network.
